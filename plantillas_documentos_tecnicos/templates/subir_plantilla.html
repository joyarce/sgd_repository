{% extends "base.html" %}

{% block content %}
<div class="container py-4" style="max-width: 780px;">

    <h3 class="mb-3 fw-semibold text-dark">
        Subir plantilla â€” {{ tipo.nombre }}
    </h3>

    <div class="card shadow-sm p-3 border-0 rounded-3">

        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="mb-3">
                <label class="form-label">Seleccionar archivo .docx</label>
                <input type="file" id="input_plantilla" name="plantilla"
                       class="form-control" accept=".docx" required>
            </div>

            <!-- ðŸ“Œ CONTROLES DETECTADOS -->
            <div id="panel_controles" class="mt-3" style="display:none;">
                <h6 class="fw-bold mb-2">Controles detectados:</h6>

                <ul id="lista_controles"
                    class="list-group list-group-flush border rounded"></ul>
            </div>

            <button class="btn btn-metso-replace mt-3">Subir plantilla</button>
        </form>

    </div>

</div>

<!-- ============================
     AJAX: detectar controles
=============================== -->
<script>
document.getElementById("input_plantilla").addEventListener("change", function() {
    let file = this.files[0];
    if (!file) return;

    let formData = new FormData();
    formData.append("archivo", file);

    fetch("{% url 'plantillas:ajax_detectar_controles' %}", {
        method: "POST",
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        let panel = document.getElementById("panel_controles");
        let lista = document.getElementById("lista_controles");
        lista.innerHTML = "";

        if (!data.ok) {
            panel.style.display = "none";
            return;
        }

        data.controles.forEach(c => {
            let li = document.createElement("li");
            li.className = "list-group-item py-1";
            li.textContent = c;
            lista.appendChild(li);
        });

        panel.style.display = "block";
    });
});
</script>

{% endblock %}

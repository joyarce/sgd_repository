{% extends "base.html" %}

{% block content %}
<div class="container py-4" style="max-width: 780px;">

    <h3 class="mb-3 fw-semibold text-dark">
        Subir plantilla — {{ tipo.nombre }}
    </h3>

    <div class="card shadow-sm p-3 border-0 rounded-3">

        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="mb-3">
                <label class="form-label">Seleccionar archivo .docx</label>
                <input type="file" id="input_plantilla" name="plantilla"
                       class="form-control" accept=".docx" required>
            </div>


            <!-- ⭐ JSON EDITOR -->
            <div id="panel_json" class="mt-4" style="display:none;">
                <h6 class="fw-bold mb-2">JSON estructural detectado:</h6>

                <div id="json_output"
                     style="height: 450px; border: 1px solid #ccc; border-radius: 5px;">
                </div>
            </div>


            <button class="btn btn-metso-replace mt-3">Subir plantilla</button>
        </form>

    </div>

</div>

<!-- ============================
     AJAX: pre-cargar JSON
=============================== -->
<script>
document.getElementById("input_plantilla").addEventListener("change", function() {

    let file = this.files[0];
    if (!file) return;

    let formData = new FormData();
    formData.append("archivo", file);

    fetch("{% url 'plantillas:ajax_detectar_controles' %}", {
        method: "POST",
        body: formData
    })
    .then(r => r.json())
    .then(data => {

        let panelJson = document.getElementById("panel_json");
        let contenedor = document.getElementById("json_output");

        if (!data.ok) {
            panelJson.style.display = "none";
            return;
        }

        // Limpiar previa instancia
        contenedor.innerHTML = "";

        // Crear JSONEditor
        const editor = new JSONEditor(contenedor, {
            mode: "view",
            navigationBar: true,
            statusBar: false,
            mainMenuBar: false,
            indentation: 4
        });

        // Cargar JSON estructural
        editor.set(data.estructura_json);

        panelJson.style.display = "block";
    });
});
</script>

{% endblock %}

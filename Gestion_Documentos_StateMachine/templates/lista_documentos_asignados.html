<!-- lista_documentos_asignados.html -->

{% extends "base.html" %}
{% load static %}
{% block title %}Mis Documentos Asignados{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .kpi-card { padding: 18px; border-radius: 8px; box-shadow: 0 1px 6px rgba(0,0,0,.06); background:#fff; }
    .kpi-value { font-size: 28px; font-weight:700; }
    .small-muted { color:#6c757d; font-size:12px; }
    tr.clickable-row { cursor: pointer; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>游늯 Documentos Asignados a {{ request.user.nombre }}</h2>

    <!-- KPIs -->
    <div class="row g-3 mt-4">
        <div class="col-md-3">
            <div class="kpi-card text-center">
                <div class="kpi-value">{{ total_docs }}</div>
                <div class="small-muted">Documentos totales</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card text-center">
                <div class="kpi-value">{{ cumplimiento }}%</div>
                <div class="small-muted">Cumplimiento estimado</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card text-center">
                <div class="kpi-value">{{ chart_actividad|length }}</div>
                <div class="small-muted">D칤as en periodo</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card text-center">
                <div class="kpi-value">{% if total_docs > 0 %}{{ total_docs|divisibleby:1 }}{% else %}0{% endif %}</div>
                <div class="small-muted">Indicador r치pido</div>
            </div>
        </div>
    </div>

    <!-- Tablas por Proyecto -->
    {% if documentos_por_proyecto %}
        {% for proyecto, docs in documentos_por_proyecto.items %}
        <h4 class="mt-5">{{ proyecto }}</h4>
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Tipo</th>
                        <th>Categor칤a</th>
                        <th>Estado</th>
                        <th>Rol</th>
                        <th>Fecha Registro</th>
                        <th>Observaciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in docs %}
                    <tr class="clickable-row" onclick="window.location.href='{% url 'detalle_documento' doc.requerimiento_id %}'">
                        <td>{{ doc.requerimiento_id }}</td>
                        <td>{{ doc.tipo_documento }}</td>
                        <td>{{ doc.categoria_documento }}</td>
                        <td>
                            <span class="badge
                                {% if doc.estado_actual == 'Borrador' %}bg-secondary
                                {% elif doc.estado_actual == 'En Revisi칩n' %}bg-info
                                {% elif doc.estado_actual == 'En Aprobaci칩n' %}bg-warning
                                {% elif doc.estado_actual == 'Aprobado' %}bg-success
                                {% elif doc.estado_actual == 'Publicado' %}bg-primary
                                {% elif 'Rechaz' in doc.estado_actual %}bg-danger
                                {% else %}bg-light text-dark{% endif %}">
                                {{ doc.estado_actual }}
                            </span>
                        </td>
                        <td>{{ doc.rol_asignado }}</td>
                        <td>{{ doc.fecha_registro|date:"d-m-Y H:i" }}</td>
                        <td>{{ doc.observaciones|default:"-" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    {% else %}
        <p class="mt-3">No tienes documentos t칠cnicos asignados actualmente.</p>
    {% endif %}

    <!-- Gr치ficos debajo de todas las tablas -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card p-3">
                <h6>Distribuci칩n por Estado</h6>
                <canvas id="chartEstado"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3">
                <h6>Por Rol Asignado</h6>
                <canvas id="chartRol"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3">
                <h6>Actividad 칔ltimos 7 D칤as</h6>
                <canvas id="chartActividad"></canvas>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card p-3">
                <h6>Tiempo promedio por etapa (hrs)</h6>
                <canvas id="chartTiempos"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3">
                <h6>Rendimiento por etapa</h6>
                <canvas id="chartRadar"></canvas>
            </div>
        </div>
    </div>

</div>

<script>
// Chart.js scripts
function buildBar(ctxId, data_json, label, options = {}) {
    const d = JSON.parse(data_json || '{"labels":[],"values":[]}');
    return new Chart(document.getElementById(ctxId), {
        type: 'bar',
        data: { labels: d.labels, datasets: [{ label: label, data: d.values, borderWidth: 1 }] },
        options: Object.assign({ responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }, options)
    });
}
function buildPie(ctxId, data_json) {
    const d = JSON.parse(data_json || '{"labels":[],"values":[]}');
    return new Chart(document.getElementById(ctxId), {
        type: 'pie',
        data: { labels: d.labels, datasets: [{ data: d.values }] },
        options: { responsive: true }
    });
}
function buildLine(ctxId, data_json) {
    const d = JSON.parse(data_json || '{"labels":[],"values":[]}');
    return new Chart(document.getElementById(ctxId), {
        type: 'line',
        data: { labels: d.labels, datasets: [{ label: 'Actividad', data: d.values, fill: false, tension: 0.3 }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });
}
function buildRadar(ctxId, data_json) {
    const d = JSON.parse(data_json || '{"labels":[],"values":[]}');
    return new Chart(document.getElementById(ctxId), {
        type: 'radar',
        data: { labels: d.labels, datasets: [{ label: 'Rendimiento', data: d.values, fill: true }] },
        options: { responsive: true }
    });
}

document.addEventListener("DOMContentLoaded", function() {
    buildPie('chartEstado', '{{ chart_estado|safe|escapejs }}');
    buildBar('chartRol', '{{ chart_rol|safe|escapejs }}', 'Documentos por Rol');
    buildLine('chartActividad', '{{ chart_actividad|safe|escapejs }}');
    buildBar('chartTiempos', '{{ chart_tiempos|safe|escapejs }}', 'Horas promedio');
    buildRadar('chartRadar', '{{ chart_radar|safe|escapejs }}');
});
</script>
{% endblock %}

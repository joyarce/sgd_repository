{% extends "base.html" %}
{% load static %}
{% block title %}Mis Documentos Asignados{% endblock %}

{% block extra_head %}
<style>
:root{
  --metso-orange:#f36f21;
  --metso-bg:#f7f7f7;
  --metso-gray:#333;
}
body{ background:var(--metso-bg); font-family:'Inter',sans-serif; }

.clickable-row:hover{ background:#fff4ed !important; cursor:pointer; }

/* KPI Cards */
.kpi-card{
  padding:20px;
  border-radius:10px;
  background:white;
  box-shadow:0 2px 8px rgba(0,0,0,0.06);
  border:1px solid #eee;
  text-align:center;
}
.kpi-value{
  font-size:28px;
  font-weight:700;
  color:var(--metso-orange);
}

/* Chart Cards */
.card-chart{
  padding:15px;
  background:white;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
  margin-bottom:22px;
}
</style>
{% endblock %}

{% block content %}
<div class="container">

  <h2 class="fw-bold mt-3">Documentos Asignados a {{request.user.nombre}}</h2>

  <!-- ========================================================= -->
  <!-- KPI RESUMEN -->
  <!-- ========================================================= -->
  <div class="row mt-4 g-3">

    <div class="col-md-3">
      <div class="kpi-card">
        <div class="kpi-value">{{ total_docs }}</div>
        <div class="text-muted small">Documentos totales</div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="kpi-card">
        <div class="kpi-value">{{ cumplimiento }}%</div>
        <div class="text-muted small">Cumplimiento estimado</div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="kpi-card">
        <div class="kpi-value">{{ chart_actividad|length }}</div>
        <div class="text-muted small">Días analizados</div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="kpi-card">
        <div class="kpi-value">
          {% if total_docs > 0 %}
            {{ total_docs }}
          {% else %}
            0
          {% endif %}
        </div>
        <div class="text-muted small">Indicador rápido</div>
      </div>
    </div>

  </div>

  <!-- ========================================================= -->
  <!-- TABLAS POR PROYECTO -->
  <!-- ========================================================= -->
  {% if documentos_por_proyecto %}
    {% for proyecto, docs in documentos_por_proyecto.items %}
      <h4 class="mt-5" style="color:var(--metso-orange);">{{ proyecto }}</h4>

      <div class="table-responsive">
        <table class="table table-hover align-middle bg-white shadow-sm">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Tipo</th>
              <th>Estado</th>
              <th>Rol</th>
              <th>Registro</th>
              <th>Obs</th>
            </tr>
          </thead>

          <tbody>
          {% for d in docs %}
            <tr class="clickable-row"
                data-href="{% url 'documentos:detalle_documento' d.requerimiento_id %}">
              <td>{{ d.requerimiento_id }}</td>
              <td>{{ d.tipo_documento }}</td>

              <td>
                <span class="badge
                  {% if d.estado_actual == 'Pendiente de Inicio' %}bg-secondary
                  {% elif d.estado_actual == 'En Elaboración' %}bg-info
                  {% elif d.estado_actual == 'En Revisión' %}bg-warning
                  {% elif d.estado_actual == 'En Aprobación' %}bg-primary
                  {% elif 'Publicado' in d.estado_actual %}bg-success
                  {% elif 'Estructuración' in d.estado_actual %}bg-danger
                  {% endif %}">
                  {{ d.estado_actual }}
                </span>
              </td>

              <td>{{ d.rol_asignado }}</td>
              <td>{{ d.fecha_registro|date:"d-m-Y" }}</td>
              <td>{{ d.observaciones|default:"-" }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

    {% endfor %}
  {% else %}
    <p class="mt-4">No tienes documentos asignados.</p>
  {% endif %}


  <!-- ========================================================= -->
  <!-- GRÁFICOS (siempre que existan datos) -->
  <!-- ========================================================= -->
  <div class="row mt-5">
    <div class="col-md-4">
      <div class="card-chart">
        <h6>Distribución por Estado</h6>
        <canvas id="chartEstado"></canvas>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card-chart">
        <h6>Por Rol Asignado</h6>
        <canvas id="chartRol"></canvas>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card-chart">
        <h6>Actividad 7 días</h6>
        <canvas id="chartActividad"></canvas>
      </div>
    </div>
  </div>

  <div class="row mt-4 mb-5">
    <div class="col-md-6">
      <div class="card-chart">
        <h6>Tiempo promedio por etapa (hrs)</h6>
        <canvas id="chartTiempos"></canvas>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card-chart">
        <h6>Rendimiento por etapa</h6>
        <canvas id="chartRadar"></canvas>
      </div>
    </div>
  </div>

</div>


<!-- ========================================================= -->
<!-- JAVASCRIPT -->
<!-- ========================================================= -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Helpers gráficos
function buildBar(id, data_json, label){
  const d = JSON.parse(data_json || '{"labels":[],"values":[]}');
  return new Chart(document.getElementById(id), {
    type:'bar',
    data:{labels:d.labels, datasets:[{label:label,data:d.values,backgroundColor:'#f36f21'}]},
    options:{responsive:true,scales:{y:{beginAtZero:true}}}
  });
}
function buildPie(id, data_json){
  const d = JSON.parse(data_json || '{"labels":[],"values":[]}');
  return new Chart(document.getElementById(id), {
    type:'pie',
    data:{labels:d.labels, datasets:[{data:d.values,backgroundColor:['#f36f21','#ffd7b5','#ffc27a','#cfcfcf']}]}
  });
}
function buildLine(id, data_json){
  const d = JSON.parse(data_json || '{"labels":[],"values":[]}');
  return new Chart(document.getElementById(id), {
    type:'line',
    data:{labels:d.labels, datasets:[{label:'Actividad',data:d.values,borderColor:'#f36f21',tension:.3}]}
  });
}
function buildRadar(id, data_json){
  const d = JSON.parse(data_json || '{"labels":[],"values":[]}');
  return new Chart(document.getElementById(id), {
    type:'radar',
    data:{labels:d.labels, datasets:[{label:'Rendimiento',data:d.values,backgroundColor:'rgba(243,111,33,0.2)',borderColor:'#f36f21'}]}
  });
}

document.addEventListener("DOMContentLoaded",function(){
  buildPie('chartEstado','{{chart_estado|safe|escapejs}}');
  buildBar('chartRol','{{chart_rol|safe|escapejs}}','Documentos por Rol');
  buildLine('chartActividad','{{chart_actividad|safe|escapejs}}');
  buildBar('chartTiempos','{{chart_tiempos|safe|escapejs}}','Horas promedio');
  buildRadar('chartRadar','{{chart_radar|safe|escapejs}}');

  document.querySelectorAll(".clickable-row").forEach(row=>{
    row.addEventListener("click",function(e){
      if(e.target.closest("a,button")) return;
      window.location.href = this.dataset.href;
    });
  });
});
</script>

{% endblock %}

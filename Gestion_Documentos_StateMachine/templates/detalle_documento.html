{% extends "base.html" %}
{% block title %}Detalle del Documento | Gesti√≥n Documental{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Encabezado -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
    <h2 class="fw-semibold text-dark mb-2">
      Documento T√©cnico ‚Äî RQ {{ documento.requerimiento_id }}
    </h2>
  </div>

  {% if mensaje %}
    <div class="alert alert-info alert-dismissible fade show" role="alert">
      {{ mensaje }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endif %}

  {% if documento %}
  <!-- Informaci√≥n principal -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header fw-semibold text-white" style="background-color: var(--metso-orange);">
      {{ documento.tipo_documento }} ({{ documento.categoria_documento }})
    </div>
    <div class="card-body">

      <p><strong>Proyecto:</strong> {{ documento.nombre_proyecto }}</p>
      <p><strong>Observaciones:</strong> {{ documento.observaciones }}</p>

      <p><strong>Estado Actual:</strong>
        {% with estado=documento.estado_actual %}
        <span class="badge
          {% if estado == 'Pendiente de Inicio' %}bg-secondary
          {% elif estado == 'En Elaboraci√≥n' %}bg-info
          {% elif estado == 'En Revisi√≥n' %}bg-warning
          {% elif estado == 'En Aprobaci√≥n' %}bg-primary
          {% elif estado == 'Publicado' %}bg-success
          {% elif 'Estructuraci√≥n' in estado or 'Rechaz' in estado %}bg-danger
          {% else %}bg-light text-dark{% endif %}">
          {{ estado }}
        </span>
        {% endwith %}
      </p>

      <p><strong>Rol Asignado:</strong> {{ documento.rol_asignado }}</p>
      <p><strong>Fecha de Registro:</strong> {{ documento.fecha_registro }}</p>

    </div>
  </div>

  {% if documento.estado_actual == "Pendiente de Inicio" %}
    <div class="alert alert-warning border-0 shadow-sm mt-3" style="font-size: 0.95rem;">
      <strong>A√∫n no se ha iniciado la elaboraci√≥n.</strong><br>
      Para acceder a la plantilla y comenzar, presiona:
      <strong>Iniciar Elaboraci√≥n</strong>.
    </div>
    <style>.hidden-in-pendiente { display:none !important; }</style>
  {% endif %}

  <!-- PLANTILLA USADA -->
  <div class="card border-info shadow-sm mb-4">
    <div class="card-header bg-info text-white fw-semibold">üìÑ Plantilla utilizada en este RQ</div>
    <div class="card-body">

      {% if plantilla_usada %}
        <p><strong>ID Versi√≥n:</strong> {{ plantilla_usada.version_id }}</p>

        <div class="d-flex gap-2">
          <a class="btn btn-outline-primary btn-sm"
             target="_blank"
             href="{{ plantilla_usada.signed_url }}">
             Ver Plantilla
          </a>
          <a class="btn btn-outline-secondary btn-sm"
             href="{{ plantilla_usada.signed_url }}"
             download>
             Descargar
          </a>
        </div>

      {% else %}
        <p class="text-muted mb-0">‚ö† No hay plantilla registrada para este requerimiento.</p>
      {% endif %}
    </div>
  </div>

  <!-- CARD COMPARACI√ìN ESTRUCTURA -->
  <div id="comparacion-controles" class="card shadow-sm mb-4 d-none">
    <div class="card-header bg-dark text-white fw-semibold">
      Comparaci√≥n autom√°tica vs estructura de la plantilla usada
    </div>
    <div class="card-body" id="comparacion-contenido">
      <p class="text-muted mb-0">Selecciona un archivo para comparar...</p>
    </div>
  </div>

  <!-- FORMULARIO DE EVENTOS -->
  {% if eventos_tuplas %}
  <form method="post" enctype="multipart/form-data" class="mb-5">
    {% csrf_token %}
    <input type="hidden" id="requerimiento-id" name="requerimiento_id" value="{{ documento.requerimiento_id }}">

    <div class="mb-3">
      <label for="evento" class="form-label">Selecciona Evento:</label>
      <select name="evento" id="evento" class="form-select" required>
        {% for ev, ev_fmt in eventos_tuplas %}
        <option value="{{ ev }}">{{ ev_fmt }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3" id="comentario-div" style="display:none;">
      <label for="comentario" class="form-label">Comentario:</label>
      <textarea name="comentario" id="comentario" class="form-control" rows="3"></textarea>
    </div>

    <div class="mb-3" id="archivo-div" style="display:none;">
      <label for="archivo" class="form-label">Archivo del Documento:</label>
      <input type="file" name="archivo" id="archivo" class="form-control">
    </div>

    <button type="submit" class="btn btn-primary">Ejecutar Evento</button>
  </form>
  {% else %}
    <div class="alert alert-secondary text-center mt-4">
      ‚öôÔ∏è No hay eventos disponibles para tu rol en este estado.
    </div>
  {% endif %}

  <!-- HISTORIAL ESTADOS -->
  <h4 class="fw-semibold mb-3" style="color: var(--metso-orange);">Historial de Estados</h4>

  {% if historial_estados %}
  <div class="horizontal-timeline mb-5">
    {% for log in historial_estados %}
    <div class="timeline-step"
      title="Usuario: {{ log.usuario_nombre|default:'-' }}&#10;Fecha: {{ log.fecha_cambio|date:'d-m-Y H:i' }}&#10;Comentario: {{ log.comentario|default:'Sin comentarios' }}">

      <div class="timeline-dot
        {% if log.estado_destino == 'Pendiente de Inicio' %}bg-secondary
        {% elif log.estado_destino == 'En Elaboraci√≥n' %}bg-info
        {% elif log.estado_destino == 'En Revisi√≥n' %}bg-warning
        {% elif log.estado_destino == 'En Aprobaci√≥n' %}bg-primary
        {% elif 'Publicado' in log.estado_destino %}bg-success
        {% elif 'Estructuraci√≥n' in log.estado_destino %}bg-danger
        {% else %}bg-light{% endif %}">
      </div>

      <span class="small text-center d-block mt-1 fw-semibold text-muted">{{ log.estado_destino }}</span>
      <span class="small text-muted d-block">{{ log.fecha_cambio|date:"d-m H:i" }}</span>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- HISTORIAL VERSIONES -->
  <h4 class="fw-semibold mb-3" style="color: var(--metso-orange);">Historial de Versiones</h4>

  <div class="table-responsive mb-5">
    <table class="table align-middle table-sm shadow-sm bg-white rounded">
      <thead class="table-light border-bottom">
        <tr class="text-muted small">
          <th>Versi√≥n</th>
          <th>Estado</th>
          <th>Fecha</th>
          <th>Usuario</th>
          <th>Comentario</th>
          <th>Archivo</th>
        </tr>
      </thead>

      <tbody>
        {% for v in historial_versiones %}
        <tr>
          <td><span class="fw-semibold">{{ v.version }}</span></td>
          <td>{{ v.estado_nombre }}</td>
          <td>{{ v.fecha|date:"d-m-Y H:i" }}</td>
          <td>{{ v.usuario_nombre|default:"-" }}</td>
          <td class="small text-muted">{{ v.comentario|default:"-" }}</td>
          <td>
            {% if v.signed_url %}
              <a href="{{ v.signed_url }}" target="_blank">Ver</a>
            {% else %}
              <span class="text-muted small">-</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted">Sin versiones registradas.</td>
        </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>

  {% endif %}
</div>

<!-- SCRIPTS -->
<script>
document.addEventListener("DOMContentLoaded", function() {

  const eventoSelect = document.getElementById("evento");
  const comentarioDiv = document.getElementById("comentario-div");
  const archivoDiv = document.getElementById("archivo-div");
  const archivoInput = document.getElementById("archivo");
  const comparacionCard = document.getElementById("comparacion-controles");
  const comparacionContenido = document.getElementById("comparacion-contenido");

  const eventosConComentario = {{ eventos_con_comentario|safe }};
  const eventosConArchivo = {{ eventos_con_archivo|safe }};


  function actualizar() {
    const ev = eventoSelect.value;
    comentarioDiv.style.display = eventosConComentario.includes(ev) ? "block" : "none";
    archivoDiv.style.display = eventosConArchivo.includes(ev) ? "block" : "none";
  }

  if (archivoInput) {
    archivoInput.addEventListener("change", function () {

      if (!archivoInput.files.length) {
        comparacionCard.classList.add("d-none");
        return;
      }

      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const form = new FormData();
      form.append("archivo", archivoInput.files[0]);

      comparacionCard.classList.remove("d-none");
      comparacionContenido.innerHTML = "<p class='text-muted'>Comparando documento...</p>";

      fetch("{% url 'documentos:validar_controles_doc_ajax' documento.requerimiento_id %}", {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken },
        body: form
      })
      .then(r => r.json())
      .then(data => {

        if (data.error) {
          comparacionContenido.innerHTML =
            `<div class='alert alert-danger'>${data.error}</div>`;
          return;
        }

        const ok = (data.status === "OK");

        let html = `
          <p><strong>Estado:</strong>
            ${ok
              ? "<span class='text-success'>Compatible con la plantilla</span>"
              : "<span class='text-danger'>Diferencias detectadas</span>"}
          </p>

          <hr>

          <h6>üìÑ Tablas Word</h6>
          <div class="row small mb-3">
            <div class="col-md-6">
              <strong>‚ö† Faltantes</strong>
              <ul>${
                data.tablas_word.faltantes.length
                  ? data.tablas_word.faltantes.map(t=>`<li>${t}</li>`).join("")
                  : "<li class='text-muted'>Ninguno</li>"
              }</ul>
            </div>
            <div class="col-md-6">
              <strong>‚Ñπ Extras</strong>
              <ul>${
                data.tablas_word.sobrantes.length
                  ? data.tablas_word.sobrantes.map(t=>`<li>${t}</li>`).join("")
                  : "<li class='text-muted'>Ninguno</li>"
              }</ul>
            </div>
          </div>

          <h6>üìä Excels embebidos</h6>
          <div class="row small mb-3">
            <div class="col-md-6">
              <strong>‚ö† Faltantes</strong>
              <ul>${
                data.excels.faltantes.length
                  ? data.excels.faltantes.map(e=>`<li>${e}</li>`).join("")
                  : "<li class='text-muted'>Ninguno</li>"
              }</ul>
            </div>
            <div class="col-md-6">
              <strong>‚Ñπ Extras</strong>
              <ul>${
                data.excels.sobrantes.length
                  ? data.excels.sobrantes.map(e=>`<li>${e}</li>`).join("")
                  : "<li class='text-muted'>Ninguno</li>"
              }</ul>
            </div>
          </div>

          <h6>üñº Im√°genes</h6>
          <div class="row small mb-3">
            <div class="col-md-6">
              <strong>‚ö† Faltantes</strong>
              <ul>${
                data.imagenes.faltantes.length
                  ? data.imagenes.faltantes.map(i=>`<li>${i}</li>`).join("")
                  : "<li class='text-muted'>Ninguno</li>"
              }</ul>
            </div>
            <div class="col-md-6">
              <strong>‚Ñπ Extras</strong>
              <ul>${
                data.imagenes.sobrantes.length
                  ? data.imagenes.sobrantes.map(i=>`<li>${i}</li>`).join("")
                  : "<li class='text-muted'>Ninguno</li>"
              }</ul>
            </div>
          </div>

          <h6>üîç Detalles T√©cnicos</h6>
          <ul class="small">${
            data.detalles.length
              ? data.detalles.map(d=>`<li>${d}</li>`).join("")
              : "<li class='text-muted'>Ninguno</li>"
          }</ul>
        `;

        comparacionContenido.innerHTML = html;

      })
      .catch(() => {
        comparacionContenido.innerHTML =
          "<div class='alert alert-danger'>Error comparando documento</div>";
      });
    });
  }

  eventoSelect.addEventListener("change", actualizar);
  actualizar();
});
</script>

{% endblock %}

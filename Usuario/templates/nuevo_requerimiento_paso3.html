<div class="step-content" id="step-3" style="display:none;">
  <h2 class="titulo-paso">Paso 3 — Asignación de Equipo de Trabajo</h2>
  <p class="subtexto-paso">
    Selecciona los participantes con el rol correspondiente.  
    Cada rol define los permisos dentro del ciclo de vida del documento técnico.
  </p>

  <div class="resumen-container">
    <section class="bloque">
      <h3>Roles y Responsabilidades</h3>

      <div class="roles-grid">
        <!-- Redactores -->
        <div class="rol-card">
          <h5>Redactores</h5>
          <select id="select-redactores" name="redactores" multiple required>
            {% for u in usuarios %}
              <option value="{{ u.0 }}">{{ u.1 }} ({{ u.2 }})</option>
            {% endfor %}
          </select>
          <small>Responsables de crear y modificar el documento.</small>
        </div>

        <!-- Revisores -->
        <div class="rol-card">
          <h5>Revisores</h5>
          <select id="select-revisores" name="revisores" multiple required>
            {% for u in usuarios %}
              <option value="{{ u.0 }}">{{ u.1 }} ({{ u.2 }})</option>
            {% endfor %}
          </select>
          <small>Evalúan el contenido técnico y su coherencia.</small>
        </div>

        <!-- Aprobadores -->
        <div class="rol-card">
          <h5>Aprobadores</h5>
          <select id="select-aprobadores" name="aprobadores" multiple required>
            {% for u in usuarios %}
              <option value="{{ u.0 }}">{{ u.1 }} ({{ u.2 }})</option>
            {% endfor %}
          </select>
          <small>Autorizan la publicación del documento final.</small>
        </div>
      </div>
    </section>

    <hr class="separador">

    <!-- Validación -->
    <div id="alerta-rol" class="alerta-rol d-none">
      Un usuario no puede ser Redactor y Revisor al mismo tiempo.
    </div>

    <!-- Resumen -->
    <section class="bloque">
      <h4>Equipo Seleccionado</h4>
      <div id="resumen-equipo" class="resumen-equipo">
        Aún no se han seleccionado usuarios.
      </div>
    </section>
  </div>
</div>

<style>
/* === Estilo general coherente con flujo_paso3 === */
.titulo-paso {
  color: #2f2f8c;
  font-weight: 700;
  margin-bottom: 6px;
}
.subtexto-paso {
  color: #555;
  margin-bottom: 16px;
  font-size: 0.95rem;
}
.resumen-container {
  background: #fff;
  border-radius: 10px;
  padding: 24px 30px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  color: #333;
  font-size: 0.93rem;
  line-height: 1.45;
}

/* === Roles === */
.roles-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 25px;
  margin-top: 10px;
}
.rol-card {
  background: #fafafa;
  border: 1px solid #ddd;
  border-left: 3px solid #2f2f8c;
  border-radius: 6px;
  padding: 15px 18px;
  display: flex;
  flex-direction: column;
}
.rol-card h5 {
  color: #2f2f8c;
  font-weight: 600;
  font-size: 1rem;
  margin-bottom: 10px;
}
.rol-card select[multiple] {
  min-height: 150px;
  border: 1px solid #d6d6d6;
  border-radius: 6px;
  background-color: #fdfdfd;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
  font-size: 0.9rem;
  padding: 6px;
}
.rol-card select[multiple]:focus {
  border-color: #f36f21;
  outline: none;
}
.rol-card small {
  color: #777;
  margin-top: 6px;
  font-size: 0.82rem;
}

/* === Alertas y resumen === */
.alerta-rol {
  background: #fff3cd;
  border: 1px solid #ffeeba;
  color: #856404;
  border-radius: 6px;
  padding: 8px 12px;
  font-size: 0.88rem;
  margin-top: 10px;
}
.resumen-equipo {
  background: #fafafa;
  border: 1px solid #eee;
  border-radius: 6px;
  padding: 10px 15px;
  font-size: 0.9rem;
  color: #333;
  min-height: 40px;
}
.separador {
  border-top: 1px solid #e5e5e5;
  margin: 20px 0;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const selects = {
    redactores: document.getElementById("select-redactores"),
    revisores: document.getElementById("select-revisores"),
    aprobadores: document.getElementById("select-aprobadores")
  };
  const resumen = document.getElementById("resumen-equipo");
  const alertaRol = document.getElementById("alerta-rol");

  function actualizarResumen() {
    let html = "";
    Object.entries(selects).forEach(([rol, sel]) => {
      const seleccionados = Array.from(sel.selectedOptions).map(o => o.text);
      if (seleccionados.length > 0)
        html += `<strong>${rol.charAt(0).toUpperCase() + rol.slice(1)}:</strong> ${seleccionados.join(", ")}<br>`;
    });
    resumen.innerHTML = html || "Aún no se han seleccionado usuarios.";
  }

  function validarRoles() {
    const redactores = Array.from(selects.redactores.selectedOptions).map(o => o.value);
    const revisores = Array.from(selects.revisores.selectedOptions).map(o => o.value);
    const conflicto = redactores.filter(id => revisores.includes(id));
    if (conflicto.length > 0) {
      conflicto.forEach(id => {
        const option = selects.revisores.querySelector(`option[value="${id}"]`);
        if (option) option.selected = false;
      });
      alertaRol.classList.remove("d-none");
      setTimeout(() => alertaRol.classList.add("d-none"), 4000);
    }
  }

  Object.values(selects).forEach(sel => {
    sel.addEventListener("change", () => {
      validarRoles();
      actualizarResumen();
    });
  });
});
</script>

<!-- flujo_paso1.html -->
<h2>Paso 1 ‚Äî Datos Generales del Proyecto</h2>

<label>Nombre del Proyecto:</label>
<input type="text" name="nombre" placeholder="Ej: Overhaul Chancador Primario" required>

<label>Descripci√≥n Funcional:</label>
<textarea name="descripcion" rows="3" placeholder="Breve descripci√≥n del proyecto..."></textarea>

<label>Abreviatura del Proyecto:</label>
<input type="text" id="abreviatura-proyecto" name="abreviatura" class="readonly-campo" placeholder="Se genera autom√°ticamente" readonly>
<small id="msg-abreviatura" class="mensaje-exito" style="display:none;">Abreviatura generada autom√°ticamente.</small>

<!-- Bloque de fechas agrupadas -->
<div class="fechas-bloque">
  <h4>Fechas Clave del Proyecto</h4>
  <p class="subtexto">Indica las fechas principales del ciclo de vida del proyecto.</p>

  <div class="fechas-grid">
    <div class="fecha-item">
      <label>Recepci√≥n / Evaluaci√≥n</label>
      <input type="date" name="fecha_recepcion_evaluacion" required>
    </div>
    <div class="fecha-item">
      <label>Inicio Planificaci√≥n</label>
      <input type="date" name="fecha_inicio_planificacion">
    </div>
    <div class="fecha-item">
      <label>Inicio Ejecuci√≥n</label>
      <input type="date" name="fecha_inicio_ejecucion">
    </div>
    <div class="fecha-item">
      <label>Cierre del Proyecto</label>
      <input type="date" name="fecha_cierre_proyecto">
    </div>
  </div>
</div>

<label>Administrador:</label>
<select name="administrador" required>
  <option value="">Selecciona un administrador</option>
  {% for u in usuarios_administrador %}
    <option value="{{ u.id }}">{{ u.nombre }} ({{ u.email }})</option>
  {% endfor %}
</select>

<label>N√∫mero de servicio:</label>
<input type="text" id="numero_servicio_input" name="numero_servicio" class="readonly-campo" placeholder="N√∫mero de servicio" readonly>
<input type="hidden" id="numero_servicio_hidden" name="numero_servicio">

<small id="mensaje-ok" class="mensaje-exito" style="display:none;">N√∫mero de servicio cargado correctamente.</small>
<small id="mensaje-error-carga" class="mensaje-error" style="display:none;">Error al leer el archivo.</small>

<label>Archivo Excel (para leer n√∫mero de orden):</label>
<input type="file" id="archivo" name="archivo" accept=".xlsx,.xls">

<label>M√°quinas del Proyecto:</label>
<select name="maquinas_ids[]" multiple required>
  {% for maquina in maquinas %}
    <option value="{{ maquina.id }}">{{ maquina.nombre }} ({{ maquina.abreviatura }})</option>
  {% endfor %}
</select>
<small>Selecciona una o varias m√°quinas asociadas al proyecto.</small>

<!-- ==================== ESTILOS ==================== -->
<style>
/* === Bloque de fechas === */
.fechas-bloque {
  margin-top: 20px;
  background: #fafafa;
  border: 1px solid #e0e0e0;
  border-radius: 10px;
  padding: 20px;
}
.fechas-bloque h4 {
  color: #2f2f8c;
  margin-bottom: 5px;
  font-weight: 700;
}
.subtexto {
  color: #666;
  font-size: 0.9rem;
  margin-bottom: 15px;
}
.fechas-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}
.fecha-item label {
  display: block;
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 4px;
}
.fecha-item input[type="date"] {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #fff;
}

/* === Campos solo lectura unificados === */
.readonly-campo {
  background-color: #f0f0f0; /* gris claro uniforme */
  color: #555;
  cursor: not-allowed;
  border: 1px solid #c9c9c9;
  width: 100%;
  border-radius: 6px;
  padding: 8px;
  transition: background-color 0.3s;
}
.readonly-campo:hover {
  background-color: #e2e2e2;
}

/* === Mensajes === */
.mensaje-exito {
  display: block;
  color: #2e7d32;
  font-size: 0.9rem;
  margin-top: 4px;
}
.mensaje-error {
  display: block;
  color: #d32f2f;
  font-size: 0.9rem;
  margin-top: 4px;
}
</style>

<!-- ==================== SCRIPTS ==================== -->
<script>
/* === Leer n√∫mero de orden desde Excel === */
const archivoInput = document.getElementById('archivo');
archivoInput.addEventListener('change', async (event) => {
  const archivo = event.target.files[0];
  if (!archivo) return;

  const formData = new FormData();
  formData.append('archivo', archivo);

  const inputOrden = document.getElementById('numero_servicio_input');
  const hiddenOrden = document.getElementById('numero_servicio_hidden');
  const mensajeOk = document.getElementById('mensaje-ok');
  const mensajeError = document.getElementById('mensaje-error-carga');

  try {
    const response = await fetch("{% url 'usuario:leer_excel_numero_servicio' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' },
      body: formData
    });
    const data = await response.json();

    if (data.numero_servicio) {
      inputOrden.value = data.numero_servicio;
      hiddenOrden.value = data.numero_servicio;
      mensajeOk.style.display = 'block';
      mensajeError.style.display = 'none';
    } else {
      mensajeOk.style.display = 'none';
      mensajeError.style.display = 'block';
      mensajeError.textContent = 'No se pudo leer el n√∫mero de orden.';
    }
  } catch (err) {
    console.error(err);
    mensajeOk.style.display = 'none';
    mensajeError.style.display = 'block';
    mensajeError.textContent = 'Error al leer el archivo.';
  }
});


/* === Generar abreviatura de proyecto autom√°ticamente === */
async function generarAbreviaturaProyecto() {
  const maquinaSelect = document.querySelector('select[name="maquinas_ids[]"]');
  const descripcionInput = document.querySelector('textarea[name="descripcion"]');
  const fechaInput = document.querySelector('input[name="fecha_recepcion_evaluacion"]');
  const abreviaturaInput = document.querySelector('#abreviatura-proyecto');
  const msgAbreviatura = document.getElementById("msg-abreviatura");

  const maquinaSeleccionada = maquinaSelect?.selectedOptions[0]?.text?.trim() || "";
  const descripcion = descripcionInput.value.trim();
  const fecha = fechaInput.value.trim();

  if (!maquinaSeleccionada || !fecha) {
    abreviaturaInput.value = "";
    msgAbreviatura.style.display = "none";
    return;
  }

  const payload = {
    maquina: maquinaSeleccionada,
    descripcion: descripcion,
    fecha_recepcion_evaluacion: fecha
  };

  try {
    const resp = await fetch("/usuario/generar_abreviatura_proyecto/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify(payload)
    });

    const data = await resp.json();
    console.log("üì¶ Respuesta abreviatura:", data);

    if (data.abreviatura) {
      abreviaturaInput.value = data.abreviatura;
      abreviaturaInput.style.backgroundColor = "#f0f0f0";
      msgAbreviatura.style.display = "block";
    } else {
      abreviaturaInput.value = "";
      abreviaturaInput.style.backgroundColor = "#f0f0f0";
      msgAbreviatura.style.display = "none";
    }
  } catch (err) {
    console.error("Error al generar abreviatura:", err);
    msgAbreviatura.style.display = "none";
  }
}


/* === Eventos din√°micos === */
document.addEventListener("DOMContentLoaded", () => {
  const descripcion = document.querySelector('textarea[name="descripcion"]');
  const fecha = document.querySelector('input[name="fecha_recepcion_evaluacion"]');
  const maquinaSelect = document.querySelector('select[name="maquinas_ids[]"]');
  const form = document.querySelector("form");

  [descripcion, fecha, maquinaSelect].forEach(el => {
    el?.addEventListener("change", generarAbreviaturaProyecto);
    el?.addEventListener("input", generarAbreviaturaProyecto);
  });

  form.addEventListener("submit", async (e) => {
    const abreviaturaInput = document.querySelector('#abreviatura-proyecto');
    if (!abreviaturaInput.value) {
      await generarAbreviaturaProyecto();
    }
  });
});
</script>

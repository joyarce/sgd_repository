<!-- crear_proyecto.html -->
{% extends "base.html" %}

{% block extra_css %}
<style>
:root {
    --metso-dark-gray: #333;
    --metso-light-gray: #f7f7f7;
    --metso-orange: #f36f21;
    --metso-orange-hover: #d65c1a;
    --metso-white: #fff;
    --metso-border-radius: 8px;
}

/* Wizard general */
body { background-color: var(--metso-light-gray); font-family: 'Inter', sans-serif; margin:0; }
.project-wizard { max-width: 1000px; margin: 40px auto; padding: 0 20px; display: grid; grid-template-columns: 200px 1fr; gap: 50px; color: var(--metso-dark-gray); }
.header-section h1 { font-size: 2.2rem; font-weight: 700; margin-bottom: 5px; }
.header-section .subtitle { color: #6a6a6a; margin-bottom: 30px; font-size: 1rem; }
.card { background: var(--metso-white); border-radius: var(--metso-border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.05); padding: 30px; margin-bottom: 25px; border: 1px solid #eee; transition: all 0.2s ease; max-height: 80vh; overflow-y: auto; }
label { display:block; margin-top:15px; margin-bottom:6px; font-weight:600; font-size: 0.95rem; }
input, select, textarea { width:100%; padding:12px; border:1px solid #e0e0e0; border-radius:var(--metso-border-radius); font-size:15px; background:#fcfcfc; transition:border-color 0.2s, box-shadow 0.2s; }
input:focus, select:focus, textarea:focus { border-color: var(--metso-orange); box-shadow:0 0 0 3px rgba(243,111,33,0.2); background:#fff; outline:none; }
textarea { resize: vertical; min-height: 100px; }
button.btn { background-color: var(--metso-orange); color: var(--metso-white); border:none; padding:12px 25px; border-radius:var(--metso-border-radius); font-size:15px; cursor:pointer; font-weight:600; transition: background 0.2s, transform 0.1s, box-shadow 0.2s; box-shadow:0 4px 8px rgba(243,111,33,0.2); }
button.btn:hover { background-color: var(--metso-orange-hover); transform: translateY(-1px); box-shadow:0 6px 12px rgba(243,111,33,0.3); }
button.btn:active { transform: translateY(1px); box-shadow:0 2px 4px rgba(243,111,33,0.2); }
.btn-secondary { background-color:#aaa; box-shadow: none; }
.btn-secondary:hover { background-color:#999; transform: none; box-shadow: none; }
.progress-bar-vertical { display: flex; flex-direction: column; padding-top: 50px; position: sticky; top: 20px; }
.step { position: relative; display: flex; align-items: center; padding: 10px 0; cursor: pointer; transition: opacity 0.2s; }
.step:not(.current):hover { opacity: 0.8; }
.step-circle { width: 30px; height: 30px; min-width: 30px; border-radius: 50%; background: #ccc; color: var(--metso-white); line-height: 30px; text-align: center; font-weight: 700; margin-right: 15px; transition: background 0.3s, border-color 0.3s; border: 3px solid var(--metso-white); box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 10; }
.step-circle.active { background-color: var(--metso-orange); border-color: #fcebe3; }
.step-label { font-size: 15px; font-weight: 500; color: #6a6a6a; transition: color 0.3s; }
.step-circle.active + .step-label { color: var(--metso-dark-gray); font-weight: 600; }
.progress-line { position: absolute; left: 15px; top: 40px; bottom: -10px; width: 3px; background-color: #ddd; z-index: 5; }
.step:last-child .progress-line { display: none; }
.form-navigation { text-align: right; margin-top: 20px; }


.step-content#step-3 { padding: 15px; background-color: #f7f9fb; border-radius: 8px; }
.step-content#step-3 .grupo-item { margin-bottom: 8px; border-radius: 6px; background-color: var(--metso-white); border: 1px solid #e0e0e0; overflow: hidden; transition: all 0.2s ease; }
.step-content#step-3 .grupo-item.active { border-color: var(--metso-orange); box-shadow: 0 2px 10px rgba(243, 111, 33, 0.1); }
.step-content#step-3 .grupo-header { padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-weight: 600; color: var(--metso-dark-gray); transition: background-color 0.15s ease; user-select: none; }
.step-content#step-3 .grupo-header:hover { background-color: #f0f0f0; }
.step-content#step-3 .grupo-header .toggle-icon { font-size: 1.1em; font-weight: 900; transition: transform 0.2s; color: var(--metso-orange); }
.step-content#step-3 .grupo-item.active .grupo-header .toggle-icon { transform: rotate(90deg); }
.step-content#step-3 .documento-list { padding: 10px 15px 10px 35px; background-color: #fcfcfc; border-top: 1px solid #eee; display: none; max-height: 200px; overflow-y: auto; }
.step-content#step-3 .documento-item { padding: 8px 0; display: flex; align-items: center; cursor: pointer; font-size: 0.9em; border-bottom: 1px dashed #eee; }
.step-content#step-3 .documento-item:last-child { border-bottom: none; }
.step-content#step-3 .documento-item input[type="checkbox"] { margin-right: 8px; }
.step-content#step-3 .roles-documento { margin: 15px 0; padding: 10px 15px; border: 1px solid #d0d0d0; border-radius: 6px; background-color: #f0f0f0; display: none; max-height: 180px; overflow-y: auto; }
.step-content#step-3 .role-group { margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px dotted #ccc; }
.step-content#step-3 .role-group:last-child { border-bottom: none; margin-bottom: 0; }
.step-content#step-3 .role-group > label { font-weight: 700; display: block; margin-bottom: 8px; color: var(--metso-dark-gray); font-size: 0.9rem; }
.step-content#step-3 .user-selection-container { display: flex; flex-wrap: wrap; gap: 5px 15px; max-height: 120px; overflow-y: auto; padding: 5px; background-color: var(--metso-white); border: 1px solid #e0e0e0; border-radius: 4px; }
.step-content#step-3 .user-selection-container label { font-weight: normal; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; }


#paso4-confirmacion { display: none; margin-top: 20px; }
#paso4-confirmacion h2 { font-size: 1.5rem; margin-bottom: 10px; }
#paso4-confirmacion ul { list-style: disc; margin-left: 20px; }
#paso4-confirmacion li { margin-bottom: 5px; }
</style>
{% endblock %}

{% block content %}
<div class="project-wizard">
    <div class="sidebar-progress">
        <div class="header-section">
            <h1>Crear Proyecto</h1>
            <p class="subtitle">Flujo de trabajo multi-paso para el registro de un nuevo proyecto.</p>
        </div>
        <div class="progress-bar-vertical">
            {% for label in steps %}
            <div class="step {% if forloop.first %}current{% endif %}" data-step="{{ forloop.counter }}">
                <div class="step-circle {% if forloop.first %}active{% endif %}">{{ forloop.counter }}</div>
                <div class="step-label">{{ label }}</div>
                <div class="progress-line"></div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="form-content">
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="current_step" id="current_step" value="1">

            {% for step_template in step_templates %}
            <div class="card step-content" id="step-{{ forloop.counter }}" style="{% if forloop.first %}display:block;{% else %}display:none;{% endif %}">
                {% include step_template %}
            </div>
            {% endfor %}

            <div class="form-navigation">
                <button type="button" class="btn btn-secondary" id="prev-step">‚Üê Anterior</button>
                <button type="button" class="btn" id="next-step">Siguiente ‚Üí</button>
                <button type="submit" class="btn" id="submit-form" style="display:none;">üíæ Crear Proyecto</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const totalSteps = {{ steps|length }};
    const nextBtn = document.getElementById('next-step');
    const prevBtn = document.getElementById('prev-step');
    const submitBtn = document.getElementById('submit-form');
    const steps = document.querySelectorAll('.step');
    const stepCircles = document.querySelectorAll('.step-circle');
    const contents = document.querySelectorAll('.step-content');
    const currentStepInput = document.getElementById('current_step');
    const proyecto_data = {};

    function initPaso4() {
        const stepContainer = document.querySelector('#step-4');
        if (!stepContainer) return;

        const toggleGrupo = (grupoItem, isChecked) => {
            const docDiv = grupoItem.querySelector('.documento-list');
            const checkbox = grupoItem.querySelector('input[name="grupo_checkbox"]');
            if (isChecked) {
                docDiv.style.display = 'block';
                grupoItem.classList.add('active');
                checkbox.checked = true;
            } else {
                docDiv.style.display = 'none';
                grupoItem.classList.remove('active');
                checkbox.checked = false;
                docDiv.querySelectorAll('input[type="checkbox"]').forEach(c => {
                    c.checked = false;
                    const rolesDiv = document.getElementById('roles-' + c.dataset.safeId + '-' + c.value);
                    if (rolesDiv) rolesDiv.style.display = 'none';
                });
            }
        };

        stepContainer.querySelectorAll('.grupo-item').forEach(grupoItem => {
            const header = grupoItem.querySelector('.grupo-header');
            const checkbox = grupoItem.querySelector('input[name="grupo_checkbox"]');

            header.addEventListener('click', function(event) {
                if (event.target === checkbox) return;
                toggleGrupo(grupoItem, !checkbox.checked);
            });

            checkbox.addEventListener('change', function() {
                toggleGrupo(grupoItem, this.checked);
            });

            if (checkbox.checked) toggleGrupo(grupoItem, true);
        });

        stepContainer.querySelectorAll('.documento-list input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', function() {
                const rolesDiv = document.getElementById('roles-' + this.dataset.safeId + '-' + this.value);
                if (rolesDiv) rolesDiv.style.display = this.checked ? 'block' : 'none';
                if (!this.checked && rolesDiv) {
                    rolesDiv.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
                }
            });
        });

        stepContainer.querySelectorAll('.roles-documento').forEach(div => {
            div.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', function() {
                    const roleName = this.name;
                    if (this.checked) {
                        stepContainer.querySelectorAll(`input[name="${roleName}"]`).forEach(other => {
                            if (other !== this) other.checked = false;
                        });
                    }
                });
            });
        });
    }

    function showStep(step) {
        currentStep = step;
        currentStepInput.value = step;

        contents.forEach(c => c.style.display = 'none');
        steps.forEach(s => s.classList.remove('current'));
        stepCircles.forEach(c => c.classList.remove('active'));

        document.getElementById(`step-${step}`).style.display = 'block';

        for (let i = 0; i < totalSteps; i++) {
            if (i < step) stepCircles[i].classList.add('active');
            if (i === step-1) steps[i].classList.add('current');
        }

        prevBtn.style.display = step > 1 ? 'inline-block' : 'none';
        nextBtn.style.display = step < totalSteps ? 'inline-block' : 'none';
        submitBtn.style.display = step === totalSteps ? 'inline-block' : 'none';

        if (step === 4) {
            initPaso4();
            renderConfirmacion();
        }
    }

    function guardarPaso(paso) {
        return new Promise((resolve, reject) => {
            const form = document.querySelector('form');
            const formData = new FormData(form);
            const data = { paso: paso, form_data: {} };

            for (let [key, value] of formData.entries()) {
                if (key === 'csrfmiddlewaretoken' || key === 'current_step') continue;
                if (key === 'archivo') continue;

                if (key.endsWith('[]')) {
                    const cleanKey = key.slice(0, -2);
                    if (!data.form_data[cleanKey]) data.form_data[cleanKey] = [];
                    data.form_data[cleanKey].push(value);
                } else {
                    data.form_data[key] = value;
                }
            }

            proyecto_data['paso_' + paso] = proyecto_data['paso_' + paso] || {};
            Object.assign(proyecto_data['paso_' + paso], data.form_data);

            fetch("{% url 'usuario:guardar_paso_proyecto' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify(data)
            })
            .then(resp => resp.json())
            .then(result => { if (result.status === 'ok') resolve(); else reject(result.error); })
            .catch(err => reject(err));
        });
    }

    function renderConfirmacion() {
        const contenedor = document.getElementById('paso4-confirmacion');
        if (!contenedor) return;
        contenedor.innerHTML = "<h2>Confirmaci√≥n Final</h2>";

        const lastPasoKey = 'paso_' + Math.max(...Object.keys(proyecto_data).map(k => parseInt(k.replace('paso_', ''))));
        const pasoData = proyecto_data[lastPasoKey];

        const pasoDiv = document.createElement('div');
        pasoDiv.classList.add('confirm-section');
        pasoDiv.innerHTML = `<h3>${lastPasoKey.replace('paso_', 'Paso ')}</h3>`;

        const ul = document.createElement('ul');
        for (const [campo, valor] of Object.entries(pasoData)) {
            const li = document.createElement('li');
            li.innerHTML = `<strong>${campo}:</strong> ${Array.isArray(valor) ? valor.join(', ') : valor}`;
            ul.appendChild(li);
        }

        pasoDiv.appendChild(ul);
        contenedor.appendChild(pasoDiv);
        contenedor.style.display = 'block';
    }

    nextBtn.addEventListener('click', async () => {
        if (currentStep < totalSteps) {
            try { await guardarPaso(currentStep); showStep(currentStep + 1); } 
            catch (error) { console.error(error); alert('Error al guardar los datos del paso.'); }
        }
    });

    prevBtn.addEventListener('click', async () => {
        if (currentStep > 1) {
            try { await guardarPaso(currentStep); showStep(currentStep - 1); } 
            catch (error) { console.error(error); alert('Error al guardar los datos del paso.'); }
        }
    });

    steps.forEach(el => el.addEventListener('click', async () => {
        try { await guardarPaso(currentStep); showStep(parseInt(el.dataset.step)); } 
        catch (error) { console.error(error); }
    }));

    showStep(currentStep);
});
</script>
{% endblock %}

<!-- nuevo_requerimiento.html -->
{% extends "base.html" %}
{% block title %}Nuevo Requerimiento T√©cnico{% endblock %}

{% block extra_css %}
<style>
:root {
    --metso-dark-gray: #333;
    --metso-light-gray: #f7f7f7;
    --metso-orange: #f36f21;
    --metso-orange-hover: #d65c1a;
    --metso-white: #fff;
    --metso-border-radius: 12px;
}

body { background-color: var(--metso-light-gray); }

.container { max-width: 1100px; margin: 40px auto; padding: 0 20px; font-family: 'Inter', sans-serif; color: var(--metso-dark-gray); }
h1 { font-size: 2.2rem; font-weight: 700; margin-bottom: 5px; }
.subtitle { color: #6a6a6a; margin-bottom: 30px; }
.card { background: var(--metso-white); border-radius: var(--metso-border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.05); padding: 30px; margin-bottom: 25px; border:1px solid #eee; }
label { display:block; margin-top:15px; margin-bottom:6px; font-weight:600; }
input, select, textarea { width:100%; padding:12px; border:1px solid #e0e0e0; border-radius:8px; font-size:15px; background:#fcfcfc; transition:border-color 0.2s, box-shadow 0.2s; }
input:focus, select:focus, textarea:focus { border-color: var(--metso-orange); box-shadow:0 0 0 3px rgba(243,111,33,0.2); background:#fff; outline:none; }
textarea { resize: vertical; }
small { display:block; color:#888; font-size:12px; margin-top:5px; }
h3 { margin-top:0; margin-bottom:20px; font-size:1.4rem; font-weight:600; color: var(--metso-dark-gray); border-bottom:2px solid var(--metso-orange); display:inline-block; padding-bottom:5px; }
.project-info { display:flex; justify-content:space-between; padding:15px 0; margin-bottom:20px; border-bottom:1px solid #eee; }
.project-info p { margin:0; font-size:14px; flex-grow:1; }
.project-info strong { color: var(--metso-orange); font-weight:700; }

button.btn {
    background-color: var(--metso-orange);
    color: var(--metso-white);
    border:none;
    padding:12px 30px;
    border-radius:8px;
    font-size:16px;
    cursor:pointer;
    font-weight:600;
    transition: background 0.2s, transform 0.1s;
    box-shadow:0 4px 10px rgba(243,111,33,0.3);
}
button.btn:hover { background-color: var(--metso-orange-hover); transform: translateY(-1px); }
button.btn:active { transform: translateY(1px); }

select[multiple] { height:150px; padding:10px; border:1px solid #ddd; }
select[multiple] option:checked { background-color: var(--metso-orange); color:#fff; }

.progress-bar { display:flex; justify-content:space-between; margin-bottom:40px; padding:0 10%; }
.step { text-align:center; position:relative; cursor:pointer; flex:1; }
.step-circle { width:35px; height:35px; border-radius:50%; background:#ccc; color:#fff; line-height:35px; font-weight:600; margin:0 auto 8px; transition:background 0.3s; border:3px solid #fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.step-circle.active { background-color: var(--metso-orange); }
.step-label { font-size:13px; color:#6a6a6a; }
.progress-line { position:absolute; top:17px; height:3px; background-color:#ddd; z-index:-1; }
.step:not(:last-child) .progress-line { left: calc(50% + 17.5px); right: calc(-50% + 17.5px); width:100%; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>Nuevo Requerimiento</h1>
    <p class="subtitle">Creaci√≥n de documento t√©cnico para el proyecto <strong>{{ proyecto.nombre }}</strong>.</p>

    <!-- ‚úÖ Barra de progreso corregida (4 pasos reales) -->
    <div class="progress-bar">
        <div class="step" data-step="1">
            <div class="step-circle active">1</div>
            <div class="step-label">Detalles</div>
            <div class="progress-line"></div>
        </div>
        <div class="step" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-label">Planificaci√≥n</div>
            <div class="progress-line"></div>
        </div>
        <div class="step" data-step="3">
            <div class="step-circle">3</div>
            <div class="step-label">Equipo</div>
            <div class="progress-line"></div>
        </div>
        <div class="step" data-step="4">
            <div class="step-circle">4</div>
            <div class="step-label">Confirmaci√≥n</div>
        </div>
    </div>

    <div class="project-info">
        <p><strong>Proyecto:</strong> {{ proyecto.nombre }}</p>
        <p><strong>ID:</strong> {{ proyecto.id }}</p>
        <p><strong>Estado:</strong> <strong style="color: #4CAF50;">En borrador</strong></p>
    </div>

    <!-- FORMULARIO PRINCIPAL -->
    <form method="POST" id="requerimiento-form">
        {% csrf_token %}
        {% include "nuevo_requerimiento_paso1.html" %}
        {% include "nuevo_requerimiento_paso2.html" %}
        {% include "nuevo_requerimiento_paso3.html" %}
        {% include "nuevo_requerimiento_paso4.html" %}

        <!-- üîπ Botonera global fija -->
        <div id="step-buttons" style="text-align:right; margin-top:30px;">
            <button type="button" class="btn" id="prev-step" style="background-color:#aaa; margin-right:10px; display:none;">‚Üê Anterior</button>
            <button type="button" class="btn" id="next-step">Siguiente ‚Üí</button>
            <button type="submit" class="btn" id="submit-form" style="display:none;">Confirmar y Crear</button>

        </div>
    </form>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const totalSteps = 4;
    const nextBtn = document.getElementById('next-step');
    const prevBtn = document.getElementById('prev-step');
    const submitBtn = document.getElementById('submit-form');
    const steps = document.querySelectorAll('.step-circle');
    const contents = document.querySelectorAll('.step-content');

    // === Mostrar paso ===
    function showStep(step) {
        currentStep = step;

        // Mostrar solo el paso activo
        contents.forEach((c, i) => {
            c.classList.toggle('active', i + 1 === step);
            c.style.display = (i + 1 === step) ? 'block' : 'none';
        });

        // Actualizar barra de progreso
        steps.forEach((c, i) => c.classList.toggle('active', i < step));

        // Control de botones
        prevBtn.style.display = step > 1 ? 'inline-block' : 'none';
        nextBtn.style.display = step < totalSteps ? 'inline-block' : 'none';
        submitBtn.style.display = step === totalSteps ? 'inline-block' : 'none';

        // Si llegamos al paso 4, generar resumen visual
        if (step === totalSteps) generarResumen();
    }

    // === Generar resumen del Paso 4 ===
    function generarResumen() {
        const resumenContainer = document.querySelector('#step-4 .container');

        // 1Ô∏è‚É£ Capturar datos de los pasos previos
        const tipoDoc = document.querySelector('#tipo_documento');
        const observaciones = document.querySelector('#observaciones');
        const fInicio = document.querySelector('#fecha_inicio_elaboracion');
        const diasInicio = document.querySelector('#alertar_dias_inicio');
        const fRevision = document.querySelector('#fecha_primera_revision');
        const diasRevision = document.querySelector('#alertar_dias_revision');
        const fEntrega = document.querySelector('#fecha_entrega');
        const diasEntrega = document.querySelector('#alertar_dias_entrega');
        const redactores = Array.from(document.querySelector('#select-redactores').selectedOptions).map(o => o.text);
        const revisores = Array.from(document.querySelector('#select-revisores').selectedOptions).map(o => o.text);
        const aprobadores = Array.from(document.querySelector('#select-aprobadores').selectedOptions).map(o => o.text);

        // 2Ô∏è‚É£ Actualizar la vista HTML del paso 4 directamente
        resumenContainer.querySelector('.card:nth-of-type(2) p:nth-of-type(1)').innerHTML =
            `<strong>Tipo:</strong> ${tipoDoc.options[tipoDoc.selectedIndex]?.text || '-'}`;
        resumenContainer.querySelector('.card:nth-of-type(2) p:nth-of-type(2)').innerHTML =
            `<strong>Observaciones:</strong> ${observaciones.value.trim() || '-'}`;

        const planificacion = resumenContainer.querySelector('.card:nth-of-type(3) ul');
        planificacion.innerHTML = `
            <li><strong>Inicio de elaboraci√≥n:</strong> ${fInicio.value || '-'}</li>
            <li><strong>Alertar d√≠as antes inicio:</strong> ${diasInicio.value || '-'}</li>
            <hr>
            <li><strong>Primera revisi√≥n:</strong> ${fRevision.value || '-'}</li>
            <li><strong>Alertar d√≠as antes revisi√≥n:</strong> ${diasRevision.value || '-'}</li>
            <hr>
            <li><strong>Entrega final:</strong> ${fEntrega.value || '-'}</li>
            <li><strong>Alertar d√≠as antes entrega:</strong> ${diasEntrega.value || '-'}</li>
        `;

        const roles = resumenContainer.querySelector('.card:nth-of-type(4)');
        roles.querySelectorAll('p')[0].innerHTML = `<strong>Redactores:</strong> ${redactores.join(', ') || '-'}`;
        roles.querySelectorAll('p')[1].innerHTML = `<strong>Revisores:</strong> ${revisores.join(', ') || '-'}`;
        roles.querySelectorAll('p')[2].innerHTML = `<strong>Aprobadores:</strong> ${aprobadores.join(', ') || '-'}`;
    }

    // === Navegaci√≥n ===
    nextBtn.addEventListener('click', () => {
        if (currentStep < totalSteps) showStep(currentStep + 1);
    });
    prevBtn.addEventListener('click', () => {
        if (currentStep > 1) showStep(currentStep - 1);
    });

    document.querySelectorAll('.step').forEach(el => {
        el.addEventListener('click', () => {
            const step = parseInt(el.dataset.step);
            showStep(step);
        });
    });

    // === Env√≠o del formulario: asegurar que todos los campos viajen ===
    document.getElementById('requerimiento-form').addEventListener('submit', function () {
        // Habilitar y mostrar todos los pasos temporalmente
        contents.forEach(c => {
            c.style.display = 'block';
            c.querySelectorAll('input, select, textarea').forEach(el => el.disabled = false);
        });
    });

    // Mostrar primer paso
    showStep(currentStep);
});
</script>
{% endblock %}



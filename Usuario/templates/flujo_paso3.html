<!-- flujo_paso3.html -->
<div class="step-inner">
  <h2>ðŸ“„ Paso 3 â€” Documentos TÃ©cnicos del Proyecto</h2>
  <p class="subtexto-paso">
    Selecciona los documentos requeridos y asigna los responsables por rol.
  </p>

  <!-- ðŸ”Ž Buscador + Filtros -->
  <div class="filtros">
    <input type="text" id="filtroBusqueda" placeholder="Buscar documento..." />
    <select id="filtroGrupo">
      <option value="">Todos los grupos</option>
      {% for grupo in grupos_maestros %}
        <option value="{{ grupo.nombre }}">{{ grupo.nombre }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- ðŸ“„ Lista de documentos -->
  <div id="listaDocumentos" class="lista-documentos">
    {% for grupo in grupos_maestros %}
      {% for doc in grupo.documentos %}
      <label class="doc-item" data-grupo="{{ grupo.nombre }}">
        <input type="checkbox" class="doc-checkbox"
               name="documentos_ids[]" value="{{ doc.id }}"
               data-nombre="{{ doc.nombre }}">
        <span class="doc-nombre">{{ doc.nombre }}</span>
        <small class="doc-grupo">({{ grupo.nombre }})</small>
      </label>
      {% endfor %}
    {% endfor %}
  </div>

  <!-- ðŸ§¾ Tabla dinÃ¡mica de asignaciones -->
  <div id="tablaAsignaciones" class="tabla-asignaciones" style="display:none;">
    <h4>ðŸ“‘ Documentos Seleccionados</h4>
    <table>
      <thead>
        <tr>
          <th>Documento</th>
          <th>Redactor(es)</th>
          <th>Revisor(es)</th>
          <th>Aprobador(es)</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tablaBody"></tbody>
    </table>
  </div>
</div>

<!-- === ESTILOS === -->
<style>
.step-inner { background:#fff; border-radius:8px; padding:25px; box-shadow:0 3px 12px rgba(0,0,0,.06); }
h2, h3 { color:#2F2F8C; font-weight:600; margin-bottom:8px; }
.subtexto-paso { color:#555; margin-bottom:15px; }

.filtros { display:flex; gap:10px; margin-bottom:15px; }
.filtros input, .filtros select {
  padding:8px 12px; border:1px solid #ddd; border-radius:6px; font-size:.9rem; flex:1;
}

.lista-documentos {
  display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:8px; margin-bottom:25px;
  max-height:260px; overflow-y:auto; background:#fafafa;
  border:1px solid #eee; padding:10px; border-radius:8px;
}
.doc-item {
  display:flex; flex-direction:column;
  background:#fff; border:1px solid #e0e0e0;
  border-radius:6px; padding:10px;
  font-size:.9rem; cursor:pointer; transition:all .15s ease;
}
.doc-item:hover { background:#fdf7f3; border-color:#f36f21; }
.doc-item input { margin-bottom:4px; }
.doc-grupo { color:#777; font-size:.8rem; }

.tabla-asignaciones h4 { margin-bottom:10px; color:#333; }
.tabla-asignaciones table { width:100%; border-collapse:collapse; }
.tabla-asignaciones th, .tabla-asignaciones td {
  border:1px solid #e6e6e6; padding:10px; vertical-align:top;
}
.tabla-asignaciones th { background:#f0f4fa; text-align:left; }

.btn-remove {
  background:#f8d7da; border:none; color:#721c24;
  border-radius:6px; padding:4px 10px; cursor:pointer;
  font-size:.8rem;
}
.btn-remove:hover { background:#f5c6cb; }

/* Tom Select */
.ts-control { border-radius:6px !important; border-color:#ccc !important; }
.ts-control .item { background:#f36f21 !important; color:#fff !important; border-radius:12px; }
.ts-dropdown { border-radius:8px !important; z-index:9999 !important; }
</style>

<!-- === LIBRERÃAS === -->
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet" />

<!-- === SCRIPT === -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const lista = document.getElementById("listaDocumentos");
  const tabla = document.getElementById("tablaAsignaciones");
  const tbody = document.getElementById("tablaBody");
  const filtroTxt = document.getElementById("filtroBusqueda");
  const filtroGrupo = document.getElementById("filtroGrupo");

  // === Diccionario de usuarios disponibles (TODOS LOS USUARIOS) ===
  const usuarios = [
    {% for u in usuarios_todos %}
      {value:"{{u.id}}", text:"{{u.nombre|escapejs}}"},
    {% endfor %}
  ];

  // === Objeto de selecciÃ³n local ===
  const seleccionados = {}; // { doc_id: { redactores:[], revisores:[], aprobadores:[] } }

  // === Manejar selecciÃ³n de documentos ===
  lista.addEventListener("change", e => {
    if (!e.target.classList.contains("doc-checkbox")) return;
    const chk = e.target;
    const id = chk.value;
    const nombre = chk.dataset.nombre;

    if (chk.checked) addRow(id, nombre);
    else removeRow(id);

    tabla.style.display = Object.keys(seleccionados).length ? "block" : "none";
  });

  // === Crear fila de asignaciÃ³n ===
  function addRow(id, nombre) {
    if (seleccionados[id]) return;
    seleccionados[id] = { redactores: [], revisores: [], aprobadores: [] };

    const tr = document.createElement("tr");
    tr.id = "row-" + id;
    tr.innerHTML = `
      <td><strong>${nombre}</strong><input type="hidden" name="documento_id[]" value="${id}"></td>
      <td><div id="hidden-redactor-${id}"></div><select id="selRed-${id}" multiple></select></td>
      <td><div id="hidden-revisor-${id}"></div><select id="selRev-${id}" multiple></select></td>
      <td><div id="hidden-aprobador-${id}"></div><select id="selApr-${id}" multiple></select></td>
      <td><button type="button" class="btn-remove" data-id="${id}">Quitar</button></td>
    `;
    tbody.appendChild(tr);

    crearSelector(`#selRed-${id}`, "redactores", `hidden-redactor-${id}`, id);
    crearSelector(`#selRev-${id}`, "revisores", `hidden-revisor-${id}`, id);
    crearSelector(`#selApr-${id}`, "aprobadores", `hidden-aprobador-${id}`, id);

    tr.querySelector(".btn-remove").addEventListener("click", () => {
      document.querySelector(`.doc-checkbox[value="${id}"]`).checked = false;
      removeRow(id);
      tabla.style.display = Object.keys(seleccionados).length ? "block" : "none";
    });
  }

  // === Crear selector TomSelect ===
  function crearSelector(selectId, role, hiddenDivId, docId) {
    const ts = new TomSelect(selectId, {
      plugins: ["remove_button"],
      options: usuarios,
      hideSelected: true,
      placeholder: "Seleccionar...",
    });

    ts.on("change", function() {
      const valores = ts.getValue();
      seleccionados[docId][role] = valores;
      syncHidden(hiddenDivId, role, docId, valores);
    });
  }

  // === Sincronizar inputs ocultos (para enviar en POST) ===
  function syncHidden(hiddenDivId, role, docId, valores) {
    const host = document.getElementById(hiddenDivId);
    host.innerHTML = "";
    const roleMap = {
      redactores: "redactor",
      revisores: "revisor",
      aprobadores: "aprobador"
    };
    valores.forEach(v => {
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = `${roleMap[role]}_id_${docId}[]`;
      input.value = v;
      host.appendChild(input);
    });
  }

  // === Eliminar fila ===
  function removeRow(id) {
    delete seleccionados[id];
    const tr = document.getElementById("row-" + id);
    if (tr) tr.remove();
  }

  // === Filtros dinÃ¡micos ===
  function filtrar() {
    const texto = filtroTxt.value.toLowerCase();
    const grupoSel = filtroGrupo.value;
    lista.querySelectorAll(".doc-item").forEach(item => {
      const matchTexto = item.querySelector(".doc-nombre").textContent.toLowerCase().includes(texto);
      const matchGrupo = !grupoSel || item.dataset.grupo === grupoSel;
      item.style.display = (matchTexto && matchGrupo) ? "flex" : "none";
    });
  }
  filtroTxt.addEventListener("input", filtrar);
  filtroGrupo.addEventListener("change", filtrar);
});
</script>

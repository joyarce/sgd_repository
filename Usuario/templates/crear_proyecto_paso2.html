<!-- crear_proyecto_paso2.html -->
<style>
/* === Estilos visuales === */
#cliente-lectura.readonly-cliente {
    background-color: #e0e0e0;
    cursor: not-allowed;
    color: #555;
}

/* Abreviatura de cliente: campo gris bloqueado con √≠cono de candado */
.readonly-abreviatura {
    background-color: #e0e0e0;
    color: #555;
    cursor: not-allowed;
    border: 1px solid #ccc;
    width: 100%;
    border-radius: 4px;
    padding: 6px;
}
.readonly-abreviatura:hover {
    background-color: #d9d9d9;
    position: relative;
}
.readonly-abreviatura:hover::after {
    content: "üîí";
    position: absolute;
    right: 10px;
    top: 5px;
    font-size: 1.1rem;
    color: #444;
}
</style>

<div class="step-inner">
    <h3>Paso 2: Contrato y Cliente</h3>

    <div class="form-card">
        <h4>Contrato</h4>

        <label>Seleccionar Contrato Existente:</label>
        <select name="contrato_id" id="select-contrato" onchange="onContratoChange(this.value)">
            <option value="">-- Nuevo Contrato --</option>
            {% for contrato in contratos %}
            <option value="{{ contrato.id }}" 
                data-cliente-id="{{ contrato.cliente_id }}"
                data-cliente-nombre="{{ contrato.cliente_nombre }}"
                {% if proyecto_temp.contrato_id|stringformat:"s" == contrato.id|stringformat:"s" %}selected{% endif %}>
                {{ contrato.numero_contrato }}
            </option>
            {% endfor %}
        </select>

        <!-- CAMPOS NUEVO CONTRATO -->
        <div id="nuevo-contrato-fields" style="margin-top:15px; {% if proyecto_temp.contrato_id %}display:none{% endif %}">
            <label>N√∫mero de Contrato:</label>
            <input type="text" name="numero_contrato" value="{{ proyecto_temp.numero_contrato|default:'' }}" required>
            <label>Monto Total:</label>
            <input type="number" name="monto_total" value="{{ proyecto_temp.monto_total|default:'' }}">
            <label>Fecha de Firma:</label>
            <input type="date" name="contrato_fecha_firma" value="{{ proyecto_temp.contrato_fecha_firma|default:'' }}">
            <label>Representante Cliente (Nombre):</label>
            <input type="text" name="representante_cliente_nombre" value="{{ proyecto_temp.representante_cliente_nombre|default:'' }}">
            <label>Correo Representante:</label>
            <input type="email" name="representante_cliente_correo" value="{{ proyecto_temp.representante_cliente_correo|default:'' }}">
            <label>Tel√©fono Representante:</label>
            <input type="text" name="representante_cliente_telefono" value="{{ proyecto_temp.representante_cliente_telefono|default:'' }}">
        </div>

        <hr class="my-3">

        <h4>Cliente</h4>
        <input type="text" id="cliente-lectura" value="" readonly style="width:100%; margin-bottom:10px; display:none;">
        <select name="cliente_id" id="select-cliente" onchange="onClienteChange(this.value)" style="{% if proyecto_temp.contrato_id %}display:none{% endif %}">
            <option value="">-- Nuevo Cliente --</option>
            {% for cliente in clientes %}
            <option value="{{ cliente.id }}"
                {% if proyecto_temp.cliente_id|stringformat:"s" == cliente.id|stringformat:"s" %}selected{% endif %}>
                {{ cliente.nombre }}
            </option>
            {% endfor %}
        </select>

        <!-- Campo abreviatura visible para cliente existente -->
        <div id="cliente-abreviatura-container" style="display:none; margin-top:10px;">
            <label>Abreviatura del Cliente:</label>
            <input type="text" id="cliente_abreviatura_existente"
                   readonly
                   class="readonly-abreviatura"
                   title="Abreviatura registrada en la base de datos">
        </div>

        <!-- CAMPOS NUEVO CLIENTE -->
        <div id="nuevo-cliente-fields" style="margin-top:15px; {% if proyecto_temp.cliente_id %}display:none{% endif %}">
            <label>Nombre:</label>
            <input type="text" name="cliente_nombre" value="{{ proyecto_temp.cliente_nombre|default:'' }}" required>

            <label>Abreviatura del Cliente:</label>
            <input type="text" id="cliente_abreviatura" name="cliente_abreviatura"
                   value="{{ proyecto_temp.cliente_abreviatura|default:'' }}"
                   readonly class="readonly-abreviatura"
                   title="Campo bloqueado: se genera autom√°ticamente">
            <small>La abreviatura se genera o carga autom√°ticamente seg√∫n el cliente seleccionado.</small>

            <label>RUT:</label>
            <input type="text" name="cliente_rut" value="{{ proyecto_temp.cliente_rut|default:'' }}" required>
            <label>Direcci√≥n:</label>
            <input type="text" name="cliente_direccion" value="{{ proyecto_temp.cliente_direccion|default:'' }}">
            <label>Correo:</label>
            <input type="email" name="cliente_correo" value="{{ proyecto_temp.cliente_correo|default:'' }}">
            <label>Tel√©fono:</label>
            <input type="text" name="cliente_telefono" value="{{ proyecto_temp.cliente_telefono|default:'' }}">
        </div>

        <hr class="my-3">

        <h4>Faena</h4>
        <label>Seleccionar Faena:</label>
        <select name="faena_id" id="select-faena" onchange="onFaenaChange()">
            <option value="">-- Nueva Faena --</option>
        </select>

        <div id="nuevo-faena-fields" style="margin-top:15px; display:none;">
            <label>Nombre de Faena:</label>
            <input type="text" name="faena_nombre" value="">
            <label>Ubicaci√≥n:</label>
            <input type="text" name="faena_ubicacion" value="">
        </div>
    </div>
</div>

<script>
function onContratoChange(contratoId) {
    const nuevoContrato = document.getElementById('nuevo-contrato-fields');
    const selectCliente = document.getElementById('select-cliente');
    const clienteLectura = document.getElementById('cliente-lectura');
    const camposCliente = document.getElementById('nuevo-cliente-fields');

    if (contratoId) {
        nuevoContrato.style.display = 'none';
        selectCliente.style.display = 'none';
        clienteLectura.style.display = 'block';
        camposCliente.style.display = 'none';

        const option = document.querySelector(`#select-contrato option[value="${contratoId}"]`);
        const clienteNombre = option.dataset.clienteNombre;
        const clienteId = option.dataset.clienteId;
        clienteLectura.value = clienteNombre;
        clienteLectura.classList.add('readonly-cliente');

        cargarFaenas(clienteId);
    } else {
        nuevoContrato.style.display = 'block';
        selectCliente.style.display = 'block';
        clienteLectura.style.display = 'none';
        clienteLectura.classList.remove('readonly-cliente');
        camposCliente.style.display = 'block';
        selectCliente.value = '';
        toggleNuevoCliente(true);
        cargarFaenas(null);
    }
}

function onClienteChange(clienteId) {
    const campoAbrevNuevo = document.getElementById('cliente_abreviatura');
    const contenedorAbrevExistente = document.getElementById('cliente-abreviatura-container');
    const campoAbrevExistente = document.getElementById('cliente_abreviatura_existente');

    toggleNuevoCliente(!clienteId);
    cargarFaenas(clienteId);

    if (clienteId) {
        // Cliente existente ‚Üí obtener abreviatura desde backend
        contenedorAbrevExistente.style.display = 'block';
        campoAbrevNuevo.parentElement.style.display = 'none';

        fetch(`/usuario/obtener_abreviatura_cliente/${clienteId}/`, {
            headers: { "Cache-Control": "no-cache" }
        })
            .then(response => response.json())
            .then(data => {
                campoAbrevExistente.value = data.abreviatura || "(sin abreviatura)";
            })
            .catch(() => {
                campoAbrevExistente.value = "(error al obtener abreviatura)";
            });
    } else {
        // Nuevo cliente ‚Üí mostrar campo generador
        contenedorAbrevExistente.style.display = 'none';
        campoAbrevNuevo.parentElement.style.display = 'block';
        generarAbreviaturaCliente();
    }
}

function generarAbreviaturaCliente() {
    const nombreCliente = document.querySelector('input[name="cliente_nombre"]').value.trim();
    const campoAbrev = document.getElementById('cliente_abreviatura');

    if (!nombreCliente) {
        campoAbrev.value = "";
        return;
    }

    fetch(`/usuario/generar_abreviatura_cliente_ajax/?nombre=${encodeURIComponent(nombreCliente)}`, {
        headers: { "Cache-Control": "no-cache" }
    })
        .then(response => response.json())
        .then(data => {
            if (data.abreviatura) campoAbrev.value = data.abreviatura;
            else campoAbrev.value = "(sin abreviatura)";
        })
        .catch(() => {
            campoAbrev.value = "(error al generar abreviatura)";
        });
}

function toggleNuevoCliente(mostrar) {
    document.getElementById('nuevo-cliente-fields').style.display = mostrar ? 'block' : 'none';
}

function cargarFaenas(clienteId) {
    const selectFaena = document.getElementById('select-faena');
    const nuevoFaena = document.getElementById('nuevo-faena-fields');
    selectFaena.innerHTML = '<option value="">-- Nueva Faena --</option>';
    nuevoFaena.style.display = 'none';

    if (!clienteId) return;
    const faenas = {{ faenas|safe }};
    faenas.forEach(f => {
        if (f.cliente_id == clienteId) {
            const opt = document.createElement('option');
            opt.value = f.id;
            opt.textContent = f.nombre;
            selectFaena.appendChild(opt);
        }
    });

    {% if proyecto_temp.faena_id %}
    selectFaena.value = "{{ proyecto_temp.faena_id }}";
    {% endif %}
    onFaenaChange();
}

function onFaenaChange() {
    const selectFaena = document.getElementById('select-faena');
    const nuevoFaena = document.getElementById('nuevo-faena-fields');
    nuevoFaena.style.display = (selectFaena.value === "") ? 'block' : 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    const nombreClienteInput = document.querySelector('input[name="cliente_nombre"]');
    if (nombreClienteInput) nombreClienteInput.addEventListener("input", generarAbreviaturaCliente);

    onContratoChange(document.getElementById('select-contrato').value);
    onClienteChange(document.getElementById('select-cliente').value);
});
</script>

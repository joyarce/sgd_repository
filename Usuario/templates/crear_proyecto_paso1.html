<div class="step-inner">
    <h2>Paso 1: Datos Generales del Proyecto</h2>

    {% if form_error %}
        <p id="mensaje-error" style="display:block;">Error: {{ form_error }}</p>
    {% endif %}

    <!-- Nombre del Proyecto -->
    <label>Nombre del Proyecto:</label>
    <input type="text" name="nombre" value="{{ proyecto_temp.nombre|default:'' }}" required>

    <!-- Descripción -->
    <label>Descripción Funcional:</label>
    <textarea name="descripcion">{{ proyecto_temp.descripcion|default:'' }}</textarea>

    <!-- Abreviatura -->
    <div style="margin-top:20px;">
        <label>Abreviatura del Proyecto:</label>
        <input type="text" id="abreviatura_proyecto" name="abreviatura" 
               value="{{ proyecto_temp.abreviatura|default:'' }}" readonly
               style="background-color:#f5f5f5; cursor:default; width:100%;">
        <small>Se genera automáticamente a partir de la primera máquina seleccionada, la descripción y la fecha de recepción.</small>
    </div>

    <!-- Fechas -->
    <div style="display:flex; gap:20px; flex-wrap:wrap; margin-top:10px;">
        <div style="flex:1;">
            <label>Fecha Recepción y Evaluación del Requerimiento:</label>
            <input type="date" name="fecha_recepcion_evaluacion" 
                   value="{{ proyecto_temp.fecha_recepcion_evaluacion|default:'' }}" required>
        </div>
        <div style="flex:1;">
            <label>Fecha Inicio Planificación:</label>
            <input type="date" name="fecha_inicio_planificacion" 
                   value="{{ proyecto_temp.fecha_inicio_planificacion|default:'' }}">
        </div>
        <div style="flex:1;">
            <label>Fecha Inicio Ejecución:</label>
            <input type="date" name="fecha_inicio_ejecucion" 
                   value="{{ proyecto_temp.fecha_inicio_ejecucion|default:'' }}">
        </div>
        <div style="flex:1;">
            <label>Fecha Cierre del Proyecto:</label>
            <input type="date" name="fecha_cierre_proyecto" 
                   value="{{ proyecto_temp.fecha_cierre_proyecto|default:'' }}">
        </div>
    </div>

    <!-- Administrador -->
    <label>Administrador:</label>
    <select name="administrador" required>
        <option value="">Selecciona</option>
        {% for u in usuarios_administrador %}
        <option value="{{ u.id }}" {% if proyecto_temp.administrador_id == u.id|stringformat:"s" %}selected{% endif %}>
            {{ u.nombre }} ({{ u.email }})
        </option>
        {% endfor %}
    </select>

    <!-- Número de Orden y Archivo -->
    <label>Número de Orden:</label>
    <div style="display:flex; gap:10px; align-items:center; margin-bottom:5px;">
        <input type="text" id="numero_orden_input" placeholder="Número de orden" readonly 
               style="flex:1; background-color:#f5f5f5; cursor:default;" 
               value="{{ proyecto_temp.numero_orden|default:'' }}">
        <input type="hidden" id="numero_orden_hidden" name="numero_orden" 
               value="{{ proyecto_temp.numero_orden|default:'' }}">
        <input type="file" id="archivo" name="archivo" style="flex:1;">
    </div>
    <div id="mensaje-ok" class="text-success" style="display:none;"></div>
    <div id="mensaje-error-carga" class="text-danger" style="display:none;"></div>

    <!-- Máquinas -->
    <h3 style="margin-top:20px;">Máquinas del Proyecto</h3>
    <select id="maquinas_seleccionadas" name="maquinas_ids[]" multiple style="width:100%; height:120px;">
        {% for maquina in maquinas %}
        <option value="{{ maquina.id }}"
            data-abreviatura="{{ maquina.abreviatura }}"
            {% if maquina.id|stringformat:"s" in proyecto_temp.maquinas_ids %}selected{% endif %}>
            {{ maquina.nombre }} ({{ maquina.abreviatura }})
        </option>
        {% endfor %}
    </select>
    <small>Seleccione una o varias máquinas.</small>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const maquinasSelect = document.getElementById('maquinas_seleccionadas');
    const descripcionInput = document.querySelector('textarea[name="descripcion"]');
    const fechaInput = document.querySelector('input[name="fecha_recepcion_evaluacion"]');
    const abreviaturaField = document.getElementById('abreviatura_proyecto');

    // Generar abreviatura a partir de la primera máquina seleccionada
    function generarAbreviatura() {
        const primeraMaquina = maquinasSelect.selectedOptions[0];
        const maquinaAbrev = primeraMaquina?.dataset.abreviatura || "";
        const descripcion = descripcionInput.value.trim().toUpperCase();
        const fecha = fechaInput.value;

        if (!maquinaAbrev || !descripcion || !fecha) {
            abreviaturaField.value = "";
            return;
        }

        const fechaObj = new Date(fecha);
        if (isNaN(fechaObj)) {
            abreviaturaField.value = "";
            return;
        }

        const mes = ("0" + (fechaObj.getMonth() + 1)).slice(-2);
        const anio = fechaObj.getFullYear().toString().slice(-2);
        const fecha_formato = mes + anio;

        const descripcion_limpio = descripcion.replace(/\s+/g, '');
        abreviaturaField.value = `${maquinaAbrev}.${descripcion_limpio}.${fecha_formato}`;
    }

    maquinasSelect.addEventListener('change', generarAbreviatura);
    descripcionInput.addEventListener('input', generarAbreviatura);
    fechaInput.addEventListener('change', generarAbreviatura);

    generarAbreviatura();

    // Lectura de número de orden desde archivo (mantener tu lógica existente)
    const archivoInput = document.getElementById('archivo');
    archivoInput.addEventListener('change', function(event) {
        const archivo = event.target.files[0];
        if (!archivo) return;

        const formData = new FormData();
        formData.append('archivo', archivo);

        fetch("{% url 'usuario:leer_excel_numero_orden' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            const inputOrden = document.getElementById('numero_orden_input');
            const hiddenOrden = document.getElementById('numero_orden_hidden');
            const mensajeOk = document.getElementById('mensaje-ok');
            const mensajeError = document.getElementById('mensaje-error-carga');

            if (data.numero_orden) {
                inputOrden.value = data.numero_orden;
                hiddenOrden.value = data.numero_orden;
                mensajeOk.style.display = 'block';
                mensajeOk.textContent = '✅ Número de orden cargado correctamente.';
                mensajeError.style.display = 'none';
            } else {
                mensajeOk.style.display = 'none';
                mensajeError.style.display = 'block';
                mensajeError.textContent = '❌ No se pudo leer el número de orden.';
            }
        })
        .catch(err => {
            console.error(err);
            const mensajeError = document.getElementById('mensaje-error-carga');
            mensajeError.style.display = 'block';
            mensajeError.textContent = '❌ Error al leer el archivo.';
        });
    });
});
</script>

<!-- crear_proyecto_paso1.html -->
<div class="step-inner">
    <h2>Paso 1: Datos Generales del Proyecto</h2>

    {% if form_error %}
        <p id="mensaje-error" style="display:block;">Error: {{ form_error }}</p>
    {% endif %}

    <label>Nombre del Proyecto:</label>
    <input type="text" name="nombre" value="{{ proyecto_temp.nombre|default:'' }}" required>

    <label>Descripci√≥n:</label>
    <textarea name="descripcion">{{ proyecto_temp.descripcion|default:'' }}</textarea>

    <div style="display:flex; gap:20px;">
        <div style="flex:1;">
            <label>Fecha de Inicio:</label>
            <input type="date" name="fecha_inicio" value="{{ proyecto_temp.fecha_inicio|default:'' }}" required>
        </div>
        <div style="flex:1;">
            <label>Fecha de Fin (estimada):</label>
            <input type="date" name="fecha_fin" value="{{ proyecto_temp.fecha_fin|default:'' }}">
        </div>
    </div>

    <label>Administrador:</label>
    <select name="administrador" required>
        <option value="">Selecciona</option>
        {% for u in usuarios_administrador %}
        <option value="{{ u.id }}" {% if proyecto_temp.administrador_id == u.id|stringformat:"s" %}selected{% endif %}>
            {{ u.nombre }} ({{ u.email }})
        </option>
        {% endfor %}
    </select>

    <label>N√∫mero de Orden:</label>
    <div style="display:flex; gap:10px; align-items:center; margin-bottom:5px;">
        <input type="text" id="numero_orden_input" placeholder="N√∫mero de orden" readonly 
               style="flex:1; background-color:#f5f5f5; cursor:default;" 
               value="{{ proyecto_temp.numero_orden|default:'' }}">
        <input type="hidden" id="numero_orden_hidden" name="numero_orden" 
               value="{{ proyecto_temp.numero_orden|default:'' }}">
        <input type="file" id="archivo" name="archivo" onchange="leerNumeroOrden(event)" style="flex:1;">
    </div>

    <div id="info-match" class="info-box info">
        üìò El n√∫mero de orden se obtiene autom√°ticamente del archivo cargado.
    </div>
    <div id="mensaje-ok" class="info-box success" style="display:none;"></div>
    <div id="mensaje-error-carga" class="info-box error" style="display:none;"></div>
</div>

<script>
function leerNumeroOrden(event) {
    const archivo = event.target.files[0];
    if (!archivo) return;

    const formData = new FormData();
    formData.append('archivo', archivo);

    fetch("{% url 'usuario:leer_excel_numero_orden' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.numero_orden) {
            document.getElementById('numero_orden_input').value = data.numero_orden;
            document.getElementById('numero_orden_hidden').value = data.numero_orden;
            document.getElementById('mensaje-ok').style.display = 'block';
            document.getElementById('mensaje-ok').textContent = '‚úÖ N√∫mero de orden cargado correctamente.';
            document.getElementById('mensaje-error-carga').style.display = 'none';
        } else {
            document.getElementById('mensaje-ok').style.display = 'none';
            document.getElementById('mensaje-error-carga').style.display = 'block';
            document.getElementById('mensaje-error-carga').textContent = '‚ùå No se pudo leer el n√∫mero de orden del archivo.';
        }
    })
    .catch(err => {
        console.error(err);
        document.getElementById('mensaje-ok').style.display = 'none';
        document.getElementById('mensaje-error-carga').style.display = 'block';
        document.getElementById('mensaje-error-carga').textContent = '‚ùå Error al leer el archivo.';
    });
}
</script>

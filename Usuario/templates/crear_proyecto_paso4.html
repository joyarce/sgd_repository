<!-- crear_proyecto_paso4.html -->
<div class="step-inner">
  <h3 style="color:#2f2f8c; font-weight:700;">Paso 4: Confirmación de Datos del Proyecto</h3>
  <p style="color:#666; margin-bottom:20px;">
    Revisa cuidadosamente toda la información antes de crear el proyecto.
  </p>

  <div id="resumen-dinamico">
    <div class="alert alert-info">
      Completa los pasos anteriores y haz clic en “Siguiente” para ver el resumen.
    </div>
  </div>
</div>

<style>
  #resumen-dinamico table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 0.9rem;
  }
  #resumen-dinamico th, #resumen-dinamico td {
    border: 1px solid #ddd;
    padding: 8px 10px;
    text-align: left;
  }
  #resumen-dinamico th {
    background: #f0f0f0;
    color: #333;
  }
  #resumen-dinamico h4 {
    color:#f36f21;
    margin-top:20px;
    font-weight:600;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const resumen = document.getElementById("resumen-dinamico");

  // Diccionario fijo de etiquetas legibles (sin transición)
  const etiquetas_legibles = {
    nombre: "Nombre del Proyecto",
    descripcion: "Descripción",
    abreviatura: "Abreviatura",
    fecha_recepcion_evaluacion: "Fecha de recepción / evaluación",
    fecha_inicio_planificacion: "Fecha de inicio de planificación",
    fecha_inicio_ejecucion: "Fecha de inicio de ejecución",
    fecha_cierre_proyecto: "Fecha de cierre del proyecto",
    administrador: "Administrador del proyecto",
    numero_orden: "Número de orden",
    cliente_id: "Cliente asociado",
    cliente_nombre: "Nombre del cliente",
    cliente_rut: "RUT del cliente",
    cliente_direccion: "Dirección del cliente",
    cliente_correo: "Correo de contacto del cliente",
    cliente_telefono: "Teléfono del cliente",
    faena_id: "Faena asociada",
    faena_nombre: "Nombre de la faena",
    faena_ubicacion: "Ubicación de la faena",
    contrato_id: "Contrato asociado",
    numero_contrato: "Número de contrato",
    monto_total: "Monto total del contrato",
    contrato_fecha_firma: "Fecha de firma del contrato",
    representante_cliente_nombre: "Nombre del representante del cliente",
    representante_cliente_correo: "Correo del representante",
    representante_cliente_telefono: "Teléfono del representante",
    maquinas_ids: "Máquinas seleccionadas",
  };

  function generarResumen() {
    const usuarios = window.usuarios_dict || {};

    // Diccionarios de valores legibles
    const clientes = {};
    document.querySelectorAll("select[name='cliente_id'] option").forEach(opt => {
      clientes[opt.value] = opt.textContent.trim();
    });

    const contratos = {};
    document.querySelectorAll("select[name='contrato_id'] option").forEach(opt => {
      contratos[opt.value] = opt.textContent.trim();
    });

    const faenas = {};
    document.querySelectorAll("select[name='faena_id'] option").forEach(opt => {
      faenas[opt.value] = opt.textContent.trim();
    });

    const maquinas = {};
    document.querySelectorAll("select[name='maquinas_ids[]'] option").forEach(opt => {
      maquinas[opt.value] = opt.textContent.trim();
    });

    const documentos = {};
    document.querySelectorAll("input.doc-checkbox").forEach(chk => {
      documentos[chk.value] = chk.dataset.nombre;
    });

    // Agrupación por paso
    const campos = document.querySelectorAll("input, select, textarea");
    const grupos = {
      "Datos Generales": [],
      "Contrato y Cliente": [],
      "Máquinas Seleccionadas": [],
      "Documentos Técnicos y Roles": []
    };

    campos.forEach(el => {
      if (!el.name || el.type === "hidden" || el.type === "file") return;

      let valor = "";
      if (el.type === "checkbox") {
        if (el.classList.contains("doc-checkbox")) return;
        valor = el.checked ? "Sí" : "No";
      } else if (el.multiple) {
        valor = Array.from(el.selectedOptions).map(o => o.text).join(", ");
      } else {
        valor = el.value.trim() || "-";
      }

      // ✅ Usa directamente las etiquetas legibles ya definidas
      const nombreLegible = etiquetas_legibles[el.name] || el.name;

      if (el.closest("#step-1")) grupos["Datos Generales"].push({campo: nombreLegible, valor});
      else if (el.closest("#step-2")) grupos["Contrato y Cliente"].push({campo: nombreLegible, valor});
      else if (el.closest("#step-3") && el.name.startsWith("maquinas_ids")) {
        grupos["Máquinas Seleccionadas"].push({campo: nombreLegible, valor});
      }
    });

    // Documentos técnicos y roles
    const documentosSeleccionados = [];
    document.querySelectorAll("input.doc-checkbox:checked").forEach(chk => {
      const docId = chk.value;
      const docNombre = documentos[docId] || `Documento ${docId}`;

      const redactores = Array.from(document.querySelectorAll(`input[name='redactor_id_${docId}[]']`))
        .map(i => usuarios[i.value] || i.value);
      const revisores = Array.from(document.querySelectorAll(`input[name='revisor_id_${docId}[]']`))
        .map(i => usuarios[i.value] || i.value);
      const aprobadores = Array.from(document.querySelectorAll(`input[name='aprobador_id_${docId}[]']`))
        .map(i => usuarios[i.value] || i.value);

      documentosSeleccionados.push({
        nombre: docNombre,
        redactor: redactores.join(", ") || "-",
        revisor: revisores.join(", ") || "-",
        aprobador: aprobadores.join(", ") || "-"
      });
    });

    // Generar HTML final
    let html = "";
    for (const [titulo, lista] of Object.entries(grupos)) {
      if (lista.length === 0) continue;
      html += `<h4>${titulo}</h4><table><tbody>`;
      lista.forEach(item => {
        let valor = item.valor;

        if (item.campo.includes("Cliente")) valor = clientes[valor] || valor;
        if (item.campo.includes("Contrato")) valor = contratos[valor] || valor;
        if (item.campo.includes("Faena")) valor = faenas[valor] || valor;
        if (item.campo.includes("Máquina")) valor = maquinas[valor] || valor;

        html += `<tr><td><strong>${item.campo}</strong></td><td>${valor}</td></tr>`;
      });
      html += `</tbody></table>`;
    }

    html += `<h4>Documentos Técnicos y Roles</h4>`;
    if (documentosSeleccionados.length > 0) {
      html += `<table><thead><tr>
        <th>Documento</th><th>Redactor(es)</th><th>Revisor(es)</th><th>Aprobador(es)</th>
      </tr></thead><tbody>`;
      documentosSeleccionados.forEach(d => {
        html += `<tr>
          <td>${d.nombre}</td>
          <td>${d.redactor}</td>
          <td>${d.revisor}</td>
          <td>${d.aprobador}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
    } else {
      html += `<p>No hay documentos seleccionados.</p>`;
    }

    resumen.innerHTML = html || "<p>No hay datos disponibles.</p>";
  }

  // Ejecutar al pasar del paso 3 al 4
  const nextBtn = document.getElementById("next-step");
  nextBtn.addEventListener("click", () => {
    const currentStep = parseInt(document.getElementById("current_step").value);
    if (currentStep === 3) setTimeout(generarResumen, 300);
  });
});
</script>
